set(TARGETNAME UPFASN1Lib)
set(DIRNAME upfasn1lib)


# Note: using a GLOB pattern, and not an explicit list,
#       as source files are really generated by asn1c and
#       are not meant to be changed by hand.
FILE(GLOB ASN1LIB_FILES *.c)

add_library(${TARGETNAME} ${ASN1LIB_FILES})

set_target_properties(${TARGETNAME} PROPERTIES SOVERSION 1)

# Suppress some warnings, as C code generated by asn1c has some quirks
target_compile_options(${TARGETNAME}
  PRIVATE -Wno-pedantic
  PRIVATE -Wno-missing-field-initializers
  PRIVATE -Wno-parentheses-equality
  PRIVATE -Wno-gnu-empty-struct
  PRIVATE -Wno-unused-parameter
  )

# Note: as an exception, since this is C code generated by asn1c,
#       headers are kept here instead of being in a subdirectory of
#       ${UPFLIB_INCLUDE_DIR}.
target_include_directories (${TARGETNAME} PUBLIC ${UPFLIB_ASN1LIB_INCLUDE_DIR})


# Note: we do not install headers for this library, as it's used only
#       internally and is not meant to be used directly
install(TARGETS ${TARGETNAME}
  ARCHIVE DESTINATION lib
  LIBRARY DESTINATION lib)

# A custom target to regenerate source files using asn1c, should we
# ever regenerate them. It assumes the correct fork and branch of asn1c has
# been compiled in the directory indicated by ASN1C_TREE_DIR
set(ASN1C_TREE_DIR "/usr/local/tmp/brchiu-asn1c")
set(ASN1C_EXECUTABLE ${ASN1C_TREE_DIR}/asn1c/asn1c)
set(ASN1C_SKELETONS_DIR ${ASN1C_TREE_DIR}/skeletons)
set(ASN1C_OPTIONS -S ${ASN1C_SKELETONS_DIR} -pdu=all -fcompound-names -findirect-choice -fno-include-deps -gen-PER)
set(ASN1C_PREFIX "S1AP_")

set(ASN1C_EXTRA_FILES
  converter-example.c 
  converter-example.mk
  Makefile.am.libasncodec
  Makefile.am.asn1convert)

add_custom_target(regen-asn1c
    COMMAND ASN1C_PREFIX=${ASN1C_PREFIX} ${ASN1C_EXECUTABLE} ${ASN1C_OPTIONS} 3GPP_TS_36.413_v14.4.0.asn
    COMMAND rm -- ${ASN1C_EXTRA_FILES}
    COMMENT "Generating ${TARGETNAME} sources with asn1c")

add_custom_target(clean-asn1c
    COMMAND rm -f -- ${ASN1C_EXTRA_FILES} *.c *.h
    COMMENT "Remove asn1c-generated sources")
